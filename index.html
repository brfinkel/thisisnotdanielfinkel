<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daniel Finkel | Stegner Fellow at Stanford, Writer</title>
  
  <!-- Preload critical resources: Fonts and the grain texture -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet" />
  <link rel="preload" href="https://grainy-gradients.vercel.app/noise.png" as="image" />
  
  <!-- SEO Meta Tags for discoverability and rich snippets -->
  <meta name="description" content="Official website of Daniel Finkel, a 2025-27 Wallace Stegner Fellow in Fiction at Stanford University and writer from Philadelphia. Currently working on a novel." />
  <meta name="keywords" content="Daniel Finkel, Daniel Finkel writer, Daniel Finkel Stegner, Daniel Finkel Stanford, Wallace Stegner Fellow, Stanford University, novelist, The Penn Review, Philadelphia writer" />
  
  <!-- Open Graph / Social Media Meta Tags for better sharing previews -->
  <meta property="og:title" content="Daniel Finkel | Stegner Fellow at Stanford, Writer" />
  <meta property="og:description" content="Official website of Daniel Finkel, a 2025-27 Wallace Stegner Fellow in Fiction at Stanford University and writer from Philadelphia. Currently working on a novel." />
  <meta property="og:type" content="profile" />
  <meta property="og:url" content="https://dsfinkel.com/" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Daniel Finkel | Stegner Fellow at Stanford, Writer" />
  <meta name="twitter:description" content="Official website of Daniel Finkel, a 2025-27 Wallace Stegner Fellow in Fiction at Stanford University and writer from Philadelphia. Currently working on a novel." />
  
  <!-- Structured Data (Schema.org) for enhanced search results -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "Daniel Finkel",
    "url": "https://dsfinkel.com/",
    "givenName": "Daniel",
    "familyName": "Finkel",
    "alumniOf": [
      {
        "@type": "EducationalOrganization",
        "name": "Stanford University",
        "sameAs": "https://www.stanford.edu/"
      },
      {
        "@type": "EducationalOrganization",
        "name": "University of Pennsylvania",
        "sameAs": "https://www.upenn.edu/"
      }
    ],
    "hasOccupation": {
      "@type": "Occupation",
      "name": "Writer"
    },
    "knowsAbout": ["Fiction Writing", "Novel Writing", "Literary Arts", "Wallace Stegner Fellowship"],
    "award": "Wallace Stegner Fellowship",
    "memberOf": {
      "@type": "Organization",
      "name": "Wallace Stegner Fellowship Program",
      "sameAs": "https://creativewriting.stanford.edu/stegner-fellowship"
    },
    "sameAs": [
      "mailto:danielsf@stanford.edu",
      "https://instagram.com/d.s.finkel",
      "https://creativewriting.stanford.edu/stegner-fellowship/current-fellows"
    ]
  }
  </script>

  <style>
    /* CSS Custom Properties for maintainability and easy theming */
    :root {
      /* Updated primary-gradient with more color stops for smoother transitions */
      --primary-gradient: linear-gradient(270deg, #333 0%, #666 25%, #999 50%, #ccc 75%, #333 100%);
      /* Updated background-gradient with more subtle, varied shades for smoother transitions */
      --background-gradient: radial-gradient(circle at center, #fefefe 0%, #f9f9f9 20%, #f0f0f0 40%, #e8e8e8 60%, #e0e0e0 80%, #d8d8d8 100%);
      --animation-duration-fast: 15s;
      --animation-duration-slow: 40s;
      --text-color: #333; /* Softer dark grey for general text */
      --link-hover-color-default: #6c63ff; /* Original link hover color as a default */
      --current-link-hover-color: var(--link-hover-color-default); /* Dynamic variable for link hover color */
      --font-serif: 'Fraunces', serif;
      --font-sans: 'Inter', sans-serif; /* Modern sans-serif font for secondary text */
    }

    /* Universal reset for margin and padding */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    /* Base styles for HTML and Body: Full viewport, flexbox centering, custom cursor */
    html, body {
      margin: 0;
      height: 100%;
      font-family: var(--font-serif); /* Default font for main content */
      display: flex; /* Flexbox for centering main content */
      justify-content: center;
      align-items: center;
      background: var(--background-gradient);
      background-size: 500% 500%; /* Enables background animation */
      background-attachment: fixed; /* Keeps background fixed during any scroll */
      animation: gradientShift var(--animation-duration-slow) ease infinite; /* Animates background position */
      overflow: hidden; /* Crucial to prevent native scrollbars for custom scroll effect */
      min-height: 100vh;
      min-width: 100vw;
      position: relative;
      cursor: none !important; /* Force hides native cursor across the entire page */
    }

    /* Force hide native cursor for all anchor links */
    a {
      cursor: none !important;
    }

    /* Custom cursor styles: Fixed position, small dot, smooth transitions */
    .custom-cursor {
      position: fixed;
      /* Left and top are now directly controlled by JavaScript for precise positioning */
      left: 0;
      top: 0;
      width: 12px; /* Increased size for better visibility as a "ball" */
      height: 12px; /* Increased size for better visibility as a "ball" */
      background-color: rgba(0, 0, 0, 0.5); /* Default semi-transparent black */
      border-radius: 50%; /* Makes it a perfect circle */
      pointer-events: none; /* Allows mouse events to pass through to elements beneath */
      z-index: 9999; /* Ensures it's always on top */
      transition: background-color 0.2s ease-out, opacity 0.2s ease-out; /* Smooth color and opacity changes */
      will-change: left, top, background-color, opacity; /* Performance hint for browser */
    }

    /* Keyframe animation for the background gradient shift */
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Keyframe animation for initial text settling effect */
    @keyframes textSettle {
      0% {
        transform: scale(1.05);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Keyframe animation for the subtle grain overlay movement */
    @keyframes grainAnimation {
      0%, 100% { background-position: 0 0; }
      10% { background-position: 1px 1px; }
      20% { background-position: -1px -1px; }
      30% { background-position: 1px 0; }
      40% { background-position: -1px 1px; }
      50% { background-position: 0 -1px; }
      60% { background-position: 1px -1px; }
      70% { background-position: -1px 0; }
      80% { background-position: 0 1px; }
      90% { background-position: -1px -1px; }
    }

    /* Main typography styles for the h1 element */
    h1 {
      font-size: clamp(1.1rem, 3.5vw, 2.2rem); /* Responsive font size */
      font-weight: 400;
      /* Adjusted width for more space and added global padding */
      width: clamp(80vw, 88vw, 1000px); 
      max-width: 1000px;
      line-height: 1.6; /* Generous line height for readability */
      text-align: left;
      
      /* Removed mix-blend-mode from h1 to remove overall text transparency */
      color: var(--text-color); /* Default text color, now solid */
      
      animation: textSettle 1.5s ease-out forwards;
      
      word-break: break-word; /* Prevents long words from overflowing */
      overflow-wrap: break-word; /* Handles word wrapping */
      margin: 0; /* Important for correct flex centering */
      font-family: var(--font-serif);
      z-index: 5;
      position: relative; /* Necessary for z-index and positioning of child elements like underlines */
      cursor: none !important; /* Force hide native cursor on h1 */
      /* Prevents text selection */
      -webkit-user-select: none; 
      -moz-user-select: none; 
      -ms-user-select: none; 
      user-select: none; 
      will-change: transform; /* Performance hint for the scroll budging animation */

      /* Add global padding to prevent clipping on all screens */
      padding-left: max(20px, 4vw);
      padding-right: max(20px, 4vw);
    }

    /* Disable hover transform on h1 as it's not part of the lovefrom.com aesthetic */
    h1:hover {
      transform: none; 
    }

    /* Ensures span elements within h1 create line breaks */
    .line-break-span {
      display: block;
    }

    /* Common styles for italic and Stegner links */
    .body-italic,
    .stegner-link {
      position: relative;
      /* Restored gradient for text fill */
      background: var(--primary-gradient);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      /* Restored mix-blend-mode for link color effect */
      mix-blend-mode: difference; 
      animation: gradientShift var(--animation-duration-fast) ease infinite; /* Links animate their own gradient */

      text-decoration: none; /* No default underline */
      cursor: default; /* Overridden by global cursor: none */
      transition: color 0.3s ease, opacity 0.3s ease, background 0.3s ease; /* Smooth transition for color, opacity, background */

      /* --- add these two lines below --- */
      padding-left: 2px;
      padding-right: 2px;
      overflow: visible;
    }

    /* Styles for hover state of specific links: Stegner Fellow and The Penn Review */
    .body-italic:hover,
    .stegner-link:hover {
      /* On hover, switch to normal blending and solid color for clear visibility */
      color: var(--current-link-hover-color) !important;
      -webkit-text-fill-color: var(--current-link-hover-color) !important; /* Important for WebKit to get solid fill */
      opacity: 1 !important; /* Ensure full opacity */
      
      mix-blend-mode: normal !important; /* Crucial to break from parent's blend mode and become solid */
      background: none !important; /* Remove the gradient background on hover for solid color */
      background-color: transparent !important; /* Ensure no background color on hover */
      
      /* Reset clipping to ensure solid color is applied to the entire text area */
      background-clip: border-box !important;
      -webkit-background-clip: border-box !important;
    }

    /* Shared underline base styles for links (Original behavior tied to h1 hover) */
    .body-italic::after,
    .stegner-link::after {
      content: '';
      position: absolute;
      bottom: -2px; /* Position beneath the text */
      left: 0;
      width: 0%; /* Initially hidden */
      height: 2px;
      background: var(--primary-gradient); /* Underline uses the text gradient */
      background-size: 400% 400%;
      background-position: 0% 50%;
      animation: gradientShift var(--animation-duration-fast) ease infinite;
      opacity: 0.5; /* Semi-transparent underline */
      transition: width 0.6s ease; /* Smooth transition for width change */
      z-index: 1; /* Ensure underline is beneath the solid text */
    }

    /* Underline appears when the entire h1 is hovered on desktop */
    h1:hover .body-italic::after {
      width: 100%;
      transition-delay: 0.125s; /* Small delay for staggered effect */
    }

    /* Underline appears when the entire h1 is hovered (no delay for stegner link) */
    h1:hover .stegner-link::after {
      width: 100%;
      transition-delay: 0s;
    }

    /* Underline retracts when the h1 is no longer hovered on desktop */
    h1:not(:hover) .body-italic::after,
    h1:not(:hover) .stegner-link::after { 
      width: 0%;
      transition-delay: 0.125s; /* Small delay on retract for consistent feel */
    }

    /* Grain texture overlay: Covers the entire screen, provides subtle visual noise */
    .grain {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* Allows clicks and interactions to pass through */
      background-image: url('https://grainy-gradients.vercel.app/noise.png');
      background-size: 100px; /* Scales the noise image */
      opacity: 0.5; /* Reduced opacity for subtlety */
      filter: none; /* No strong filters for natural look */
      z-index: 20; /* Ensures it's above background but below main content */
      mix-blend-mode: overlay; /* Soft blend with content below */
      animation: grainAnimation 1s linear infinite; /* Animates the grain for a live effect */
    }

    /* Contact information block: Fixed position, discreet styling */
    .contact-text {
      position: fixed;
      right: 18px;
      bottom: 12px;
      font-size: 0.75rem; /* Slightly smaller for discreteness */
      color: #666; /* Softer text color */
      z-index: 30; /* Ensures it's above other elements */
      opacity: 0.8; /* Slightly opaque for a subtle presence */
      display: flex;
      flex-direction: row;
      align-items: center;
      font-family: var(--font-sans); /* Uses the sans-serif font */
      pointer-events: auto; /* Allows interaction with contact links */
      user-select: text; /* Allows text selection for copying contact info */
      gap: 16px; /* Spacing between links */
    }

    /* Styles for individual contact links, with hover effects */
    .contact-text a {
      color: #666; /* Inherits softer color */
      text-decoration: none;
      font-size: 0.75rem; /* Consistent font size */
      /* Smooth transitions for color, transform, and opacity */
      transition: color 0.3s ease, transform 0.2s ease-out, opacity 0.2s ease-out;
      opacity: 0.85; /* Default opacity */
      font-family: var(--font-sans);
      position: relative;
      display: inline-block; /* Required for transform to work correctly on inline elements */
      /* New: Larger clickable area using padding */
      padding: 5px 8px; /* Adds padding to increase hover area */
      margin: -5px -8px; /* Negative margin to offset padding and maintain original visual position */
    }

    /* Hover effect for contact links: lift, scale, and full opacity */
    .contact-text a:hover {
      color: var(--current-link-hover-color); /* Now uses dynamic color */
      transform: translateY(-3px) scale(1.1); /* Lifts up and scales slightly */
      opacity: 1; /* Becomes fully opaque */
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 700px) {
      h1 {
        font-size: clamp(1rem, 4.5vw, 1.4rem);
        /* Width is adjusted for mobile too, padding is global max(20px, 4vw) */
        width: clamp(88vw, 92vw, 95vw); 
        /* Removed padding: 0 max(16px, 4vw); from here, as it's now handled globally */
      }
      
      .contact-text {
        font-size: 0.65rem; 
        bottom: 8px;
        right: 8px; /* Keep it on the right */
        left: auto; /* Remove conflicting 'left' property */
        transform: none; /* Remove conflicting transform */
        gap: 8px; 
        padding: 0 8px; /* Adjusted padding for better fit on small screens */
        white-space: nowrap; /* Prevent wrapping */
      }

      /* On mobile, links are solid colored and always underlined */
      .body-italic,
      .stegner-link {
        mix-blend-mode: normal; /* Force normal blend mode on mobile for stability */
        background: none; /* Remove gradient background */
        background-color: transparent; /* Ensure no background color */
        -webkit-background-clip: border-box; /* Reset clipping */
        background-clip: border-box; /* Reset clipping */
        color: var(--text-color); /* Force a solid default text color on mobile */
        -webkit-text-fill-color: var(--text-color); /* For WebKit browsers */
      }
      
      /* FOR MOBILE: Force underline to always be visible for links */
      .body-italic::after,
      .stegner-link::after {
        width: 100%; /* Always show underline on mobile */
        opacity: 0.5; /* Keep opacity consistent with desktop underline */
        transition-delay: 0s; /* No delay on mobile */
      }
      
      .contact-text a {
        font-size: 0.85rem; /* Slightly larger for easier tapping */
        padding: 8px 12px; /* Increased padding for larger touch target */
        margin: -8px -12px; /* Adjust negative margin to offset padding */
      }
    }

    /* Accessibility: Disable animations for users preferring reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        transition-property: all !important; /* Apply to all transitionable properties */
        transition-delay: 0s !important; /* No delay */
      }
    }
  </style>
</head>

<body>
  <h1>
    <span class="line-break-span">Daniel Finkel is a writer from Philadelphia.</span>
    A 2025-27 <a href="https://creativewriting.stanford.edu/stegner-fellowship/meet-stegner-fellows" target="_blank" rel="noopener" class="stegner-link">Stegner Fellow</a> at Stanford and former editor-in-chief of
    <a href="https://www.pennreview.org/" target="_blank" rel="noopener" class="body-italic">The Penn Review</a>, he is currently working on a novel about undercover <span>spies</span> in a union election.
  </h1>
  
  <div class="grain"></div>
  <div class="custom-cursor"></div> <!-- Custom dot cursor element -->
  
  <div class="contact-text">
    <a href="mailto:danielsf@stanford.edu">email</a>
    <a href="https://instagram.com/d.s.finkel" target="_blank" rel="noopener">instagram</a>
  </div>

  <script>
    (function() {
      'use strict';
      
      const customCursor = document.querySelector('.custom-cursor');
      let animationId; // Single requestAnimationFrame ID for the main animation loop

      let scrollOffset = 0; 
      let targetScrollOffset = 0; 
      const scrollAmplitude = 80; 
      const scrollSensitivity = 0.6; 
      const scrollDamping = 0.08; 
      const scrollSpring = 0.5; 
      let rAFScroll; // RequestAnimationFrame ID for the scroll effect

      // Primary colors for the ball and link hovers (reverted to original values)
      const primaryColors = [
        'hsl(0, 80%, 55%)',    // Vibrant Red
        'hsl(200, 100%, 40%)', // Intense Blue
        'hsl(45, 80%, 50%)',   // Richer Golden Yellow
        'hsl(140, 70%, 45%)'   // Lively Green
      ];
      let currentColorIndex = 0; 

      // Cursor state variables for autonomous movement
      let isBallAutonomous = false; // true when ball is bouncing on its own, false when user is interacting
      let autonomousCursorX = window.innerWidth / 2; // Position for autonomous movement
      let autonomousCursorY = window.innerHeight / 2; // Position for autonomous movement
      let autonomousCursorVx = 0; // Velocity for autonomous movement
      let autonomousCursorVy = 0; // Velocity for autonomous movement
      let cursorSize = 0; 
      
      // Last known client X/Y for direct following when not autonomous
      let lastClientX = window.innerWidth / 2; 
      let lastClientY = window.innerHeight / 2; 

      const screensaverDamping = 0.7; 

      // Inactivity timer management for desktop fallback
      let inactivityTimeoutId = null;
      const INACTIVITY_DELAY_DESKTOP_MS = 3000; // Desktop screensaver delay

      // Detect mobile device more reliably
      const isMobileDevice = /Mobi|Android/i.test(navigator.userAgent) || ('ontouchstart' in window);

      // --- Main Animation Loop ---
      function mainAnimationLoop() {
        if (isBallAutonomous) {
          // Autonomous Mode: Update position and handle bouncing
          autonomousCursorX += autonomousCursorVx;
          autonomousCursorY += autonomousCursorVy;

          const maxX = window.innerWidth - cursorSize;
          const maxY = window.innerHeight - cursorSize;
          let bounced = false;

          // Bounce off horizontal walls
          if (autonomousCursorX <= 0) {
            autonomousCursorX = 0; 
            autonomousCursorVx *= -1; 
            bounced = true;
          } else if (autonomousCursorX >= maxX) {
            autonomousCursorX = maxX; 
            autonomousCursorVx *= -1;
            bounced = true;
          }

          // Bounce off vertical walls
          if (autonomousCursorY <= 0) {
            autonomousCursorY = 0; 
            autonomousCursorVy *= -1; 
            bounced = true;
          } else if (autonomousCursorY >= maxY) {
            autonomousCursorY = maxY; 
            autonomousCursorVy *= -1;
            bounced = true;
          }

          if (bounced) {
              // Change color on bounce
              customCursor.style.backgroundColor = primaryColors[currentColorIndex % primaryColors.length];
              currentColorIndex++; 
              
              // Apply damping to velocity after bounce
              autonomousCursorVx *= screensaverDamping;
              autonomousCursorVy *= screensaverDamping; 

              // Ensure a minimum speed to prevent stopping entirely
              const currentSpeed = Math.sqrt(autonomousCursorVx * autonomousCursorVx + autonomousCursorVy * autonomousCursorVy);
              const minSpeedAfterBounce = 1; 
              if (currentSpeed < minSpeedAfterBounce) {
                  const angle = Math.random() * Math.PI * 2;
                  autonomousCursorVx = Math.cos(angle) * minSpeedAfterBounce;
                  autonomousCursorVy = Math.sin(angle) * minSpeedAfterBounce;
              }
          }
          // Apply autonomous position
          customCursor.style.left = `${autonomousCursorX}px`;
          customCursor.style.top = `${autonomousCursorY}px`;

        } else {
          // User-controlled mode: Directly follow the last known mouse/touch position
          customCursor.style.left = `${lastClientX - (cursorSize / 2)}px`;
          customCursor.style.top = `${lastClientY - (cursorSize / 2)}px`;
        }
        
        animationId = requestAnimationFrame(mainAnimationLoop);
      }

      // --- Cursor State Management Functions ---

      // Starts the ball's autonomous (bouncing) movement
      function startBallAutonomousMovement() {
        if (isBallAutonomous) return; // Already autonomous

        isBallAutonomous = true;
        customCursor.style.opacity = '1'; // Always opaque when autonomous

        // When starting autonomous movement, initialize autonomousCursorX/Y from current visual position
        autonomousCursorX = customCursor.offsetLeft;
        autonomousCursorY = customCursor.offsetTop;
        
        // Ensure some velocity if it's currently stopped or too low
        const currentSpeed = Math.sqrt(autonomousCursorVx * autonomousCursorVx + autonomousCursorVy * autonomousCursorVy);
        const minAutonomousSpeed = 3; // Minimum speed for autonomous movement
        const maxAutonomousSpeed = 7; // Max speed for autonomous movement

        if (currentSpeed < minAutonomousSpeed) {
            // If speed is too low, give it a fresh random direction and a speed within a desired range
            const angle = Math.random() * Math.PI * 2;
            const newSpeed = minAutonomousSpeed + Math.random() * (maxAutonomousSpeed - minAutonomousSpeed);
            autonomousCursorVx = Math.cos(angle) * newSpeed;
            autonomousCursorVy = Math.sin(angle) * newSpeed;
        } else if (currentSpeed > maxAutonomousSpeed) {
            // If speed is too high (e.g., from a quick flick), scale it down
            const scaleFactor = maxAutonomousSpeed / currentSpeed;
            autonomousCursorVx *= scaleFactor;
            autonomousCursorVy *= scaleFactor;
        }
        // If currentSpeed is within [minAutonomousSpeed, maxAutonomousSpeed], keep its current velocity.
      }

      // Stops autonomous movement and prepares for user control or idle state
      function stopBallAutonomousMovement(e) {
        // If already not autonomous, and opacity/color indicate it's under user control or link hover, do nothing
        if (!isBallAutonomous && customCursor.style.opacity === '1' && customCursor.style.backgroundColor !== 'rgba(0, 0, 0, 0.5)') {
            return; 
        }

        isBallAutonomous = false;
        // Only set opacity to 0.5 if it's a desktop device not interacting with a link
        if (!isMobileDevice) {
            customCursor.style.backgroundColor = 'rgba(0, 0, 0, 0.5)'; // Reset color to default semi-transparent black
            customCursor.style.opacity = '0.5'; // Reset opacity to default semi-transparent
        }
        
        // When stopping autonomous, snap lastClientX/Y to the current event's coordinates.
        // This ensures the direct follow mode starts from the correct point.
        if (e && (e.clientX !== undefined || (e.touches && e.touches[0] && e.touches[0].clientX !== undefined))) {
            lastClientX = e.clientX !== undefined ? e.clientX : e.touches[0].clientX;
            lastClientY = e.clientY !== undefined ? e.clientY : e.touches[0].clientY;
        } else {
            // Fallback for cases where event might not be available (e.g., mouseleave without explicit coords)
            lastClientX = customCursor.offsetLeft + (cursorSize / 2);
            lastClientY = customCursor.offsetTop + (cursorSize / 2);
        }
      }

      // --- Inactivity Timer Management ---

      // Starts the inactivity timer for desktop (or mobile after touch ends)
      function startInactivityTimer() {
        clearTimeout(inactivityTimeoutId);
        inactivityTimeoutId = setTimeout(startBallAutonomousMovement, INACTIVITY_DELAY_DESKTOP_MS);
      }

      // Clears the inactivity timer (called on any user interaction)
      function clearInactivityTimer() {
        clearTimeout(inactivityTimeoutId);
        inactivityTimeoutId = null;
      }

      // --- Event Handlers for Cursor Movement ---

      // Handles mousemove and touchmove to control the ball
      function handleMove(e) {
        clearInactivityTimer(); // Any interaction resets the inactivity timer

        // If we're coming from an autonomous state, immediately stop it and revert appearance
        if (isBallAutonomous) {
            stopBallAutonomousMovement(e); // This will set isBallAutonomous to false and revert appearance
        }
        
        customCursor.style.opacity = '1'; // Make ball opaque when user is interacting directly

        // Update lastClientX and lastClientY from the event
        lastClientX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0] ? e.touches[0].clientX : lastClientX);
        lastClientY = e.clientY !== undefined ? e.clientY : (e.touches && e.touches[0] ? e.touches[0].clientY : lastClientY);
      }

      // --- Scroll "Budging" Effect Logic ---
      const h1 = document.querySelector('h1'); 
      let initialTouchY = 0; // For tracking vertical swipe distance

      function handleWheel(e) {
        e.preventDefault(); 
        clearInactivityTimer(); // Interaction resets timer
        
        targetScrollOffset += -e.deltaY * scrollSensitivity;
        targetScrollOffset = Math.max(-scrollAmplitude, Math.min(scrollAmplitude, targetScrollOffset));

        if (!rAFScroll) { 
          rAFScroll = requestAnimationFrame(animateScrollEffect);
        }
      }

      function handleTouchStart(e) {
        initialTouchY = e.touches[0].clientY;
        handleMove(e); // Use handleMove for initial position and velocity setup
      }

      function handleTouchMove(e) {
        e.preventDefault(); // Prevent native scrolling for custom budging effect
        handleMove(e); // Use handleMove to update position and velocity for drag
      }

      function handleTouchEnd(e) {
        // When touch ends, immediately switch to autonomous mode,
        // retaining the last velocity from touchmove
        startBallAutonomousMovement();
        // The inactivity timer will naturally restart after this,
        // or if the user doesn't touch again, the ball will continue bouncing.
      }

      function animateScrollEffect() {
        const delta = targetScrollOffset - scrollOffset;
        scrollOffset += delta * scrollSpring;

        targetScrollOffset *= (1 - scrollDamping);

        if (Math.abs(delta) < 0.1 && Math.abs(targetScrollOffset) < 0.1) {
          scrollOffset = 0; 
          targetScrollOffset = 0;
          if (h1) { 
            h1.style.transform = `none`; 
          }
          rAFScroll = null; 
          return;
        }

        if (h1) { 
          h1.style.transform = `translateY(${scrollOffset}px)`;
        }
        
        rAFScroll = requestAnimationFrame(animateScrollEffect);
      }
      
      // --- Custom Cursor Link Hover Color & Opacity Logic ---
      function initializeCursorLinkHover() {
        const allLinks = document.querySelectorAll('a'); 

        allLinks.forEach(link => {
          link.addEventListener('mouseenter', () => {
            clearInactivityTimer(); // Interaction resets timer
            stopBallAutonomousMovement(); // Stop autonomous movement, reset appearance to default
            
            const newColor = primaryColors[currentColorIndex % primaryColors.length];
            customCursor.style.backgroundColor = newColor;
            customCursor.style.opacity = '1'; 
            document.documentElement.style.setProperty('--current-link-hover-color', newColor); 
            currentColorIndex++; 
          });

          link.addEventListener('mouseleave', () => {
            if (!isMobileDevice) { // Only desktop returns to semi-transparent idle on mouseleave
                stopBallAutonomousMovement(); // Reset opacity and color to default
                startInactivityTimer(); // Restart timer for screensaver
            }
            document.documentElement.style.setProperty('--current-link-hover-color', 'var(--link-hover-color-default)');
          });

          // Touch equivalents for link hover effect
          link.addEventListener('touchstart', () => {
              clearInactivityTimer();
              stopBallAutonomousMovement(); // Stop autonomous, reset appearance
              
              const newColor = primaryColors[currentColorIndex % primaryColors.length];
              customCursor.style.backgroundColor = newColor;
              customCursor.style.opacity = '1'; 
              document.documentElement.style.setProperty('--current-link-hover-color', newColor); 
              currentColorIndex++; 
          });

          link.addEventListener('touchend', () => {
              // On touchend for links, the overall touchend handler will call startBallAutonomousMovement().
              // We only need to reset the link hover color property here.
              document.documentElement.style.setProperty('--current-link-hover-color', 'var(--link-hover-color-default)'); 
          });
        });
      }

      // --- Initialization on DOM Ready ---
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupListeners);
      } else {
        setupListeners();
      }

      function setupListeners() {
        cursorSize = customCursor.offsetWidth; 

        // General interaction events
        document.addEventListener('mousemove', handleMove, { passive: true }); 
        window.addEventListener('wheel', handleWheel, { passive: false }); 
        
        document.addEventListener('touchstart', handleTouchStart, { passive: false });
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('touchend', handleTouchEnd, { passive: false });

        initializeCursorLinkHover(); 
        
        // Handle desktop-specific mouseleave/focus for screensaver
        if (!isMobileDevice) {
            document.body.addEventListener('mouseleave', startBallAutonomousMovement); // Starts screensaver immediately on mouseleave
            document.body.addEventListener('mouseenter', stopBallAutonomousMovement); // Stops screensaver on mouseenter
            window.addEventListener('blur', startBallAutonomousMovement); // Activates screensaver on window blur
            window.addEventListener('focus', stopBallAutonomousMovement); // Deactivates screensaver on window focus
        } else {
            // On mobile, start autonomous movement immediately on load
            startBallAutonomousMovement();
            // The touch events (touchstart, touchend) will then manage switching between user control and autonomous
        }

        // Start the main animation loop
        mainAnimationLoop();
      }
    })();
  </script>
</body>
</html>
